<!DOCTYPE html>
<html lang="ml">

<head>
    <span id="headContainer"></span>
    <script>
        TITLE = "ISP";
    </script>
</head>

<body>
    <div class="loader" id="pageLoader">
        <div class="spinner"></div>
    </div>

    <span id="navbarContainer"></span>

    <header class="text-white text-center py-3">
        <div class="container">
            <h1 class="page-title"></h1>
            <p id="subtitle"></p>
            <nav aria-label="breadcrumb" class="custom-breadcrumb rounded p-2 mt-3">
                <ol class="breadcrumb justify-content-center mb-0">
                    <li class="breadcrumb-item"><a href="index.html" class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item"><a href="life.html" class="text-decoration-none">Life</a></li>
                    <li class="breadcrumb-item"><a href="#" class="text-decoration-none" id="topicMenu"></a></li>
                    <li class="breadcrumb-item active page-title" aria-current="page"></li>
                </ol>
            </nav>
        </div>
    </header>

    <main class="container my-3">
        <div class="bg-white p-4 rounded shadow-sm">
            <span id="content"></span>

            <div class="text-center d-none" id="shareBox">
                <div class="p-4 rounded-4 shadow-sm share-box">
                    <h4 class="fw-bold mb-3">üì§ ‡¥à ‡¥µ‡¥ø‡¥µ‡¥∞‡¥Ç ‡¥Æ‡¥±‡µç‡¥±‡µÅ‡¥≥‡µç‡¥≥‡¥µ‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥Ç ‡¥é‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÇ</h4>
                    <p class="mb-4">
                        ‡¥¶‡µÅ‡¥Ü‡¥Ø‡µÅ‡¥Ç ‡¥ñ‡µà‡¥∞‡µÅ‡¥Ç ‡¥Æ‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡¥µ‡¥®‡µç‡¥±‡µÜ ‡¥™‡¥ø‡¥®‡µç‚Äç‡¥ï‡¥æ‡¥≤‡¥§‡µç‡¥§‡µç ‡¥§‡µÅ‡¥ü‡¥∞‡¥æ‡¥Ç. ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥í‡¥∞‡µÅ ‡¥™‡¥ô‡µç‡¥ï‡µÅ‡¥µ‡µÜ‡¥™‡µç‡¥™‡µç ‡¥Æ‡¥±‡µç‡¥±‡µä‡¥∞‡¥æ‡¥≥‡µÜ
                        ‡¥ì‡µº‡¥Æ‡µç‡¥Æ‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç.
                    </p>
                    <a href="#" class="btn btn-primary rounded-pill px-4">üîó ‡¥∑‡µÜ‡¥Ø‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÇ</a>
                </div>
            </div>
        </div>
    </main>

    <span id="footerContainer"></span>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/custom.js"></script>

    <script type="module">
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD9CrCyr09c27TBi-yViwyk0l8HN340IHQ",
            authDomain: "isp-db-2330.firebaseapp.com",
            projectId: "isp-db-2330",
            storageBucket: "isp-db-2330.firebasestorage.app",
            messagingSenderId: "466666491726",
            appId: "1:466666491726:web:c5e9649793d8352465581f",
            measurementId: "G-CMDJLRF946"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            query,
            where,
            doc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // async function saveData(fs_db, filePath) {
        //     const res = await fetch(filePath);
        //     const topics = await res.json();

        //     for (const topic of topics) {
        //         const ref = doc(db, fs_db, topic.id.toString());
        //         await setDoc(ref, topic);
        //         console.log("‚úÖ Uploaded:", topic.title);
        //     }
        // }
        // saveData("death", "db/death.json");

        document.addEventListener("DOMContentLoaded", async () => {
            const idParam = new URLSearchParams(window.location.search).get("id");
            const id = parseInt(idParam);
            const topicIdParam = new URLSearchParams(window.location.search).get("topic");
            const topicId = parseInt(topicIdParam);
            const loader = document.getElementById("pageLoader");
            const contentContainer = document.querySelector("#content");
            let docTitle = "ISP";

            if (!id || isNaN(id) || !topicId || isNaN(topicId)) {
                contentContainer.innerHTML = `<div class="text-danger text-center">‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥Ø ID ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡µÅ.</div>`;
                if (loader) loader.style.display = "none";
                return;
            }

            try {
                const qry = query(collection(db, "life_of_muslim"), where("id", "==", topicId));
                const qrySnapshot = await getDocs(qry);

                if (qrySnapshot.empty) {
                    contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                    return;
                }

                qrySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();

                    docTitle += " - " + data.ml_title;
                    document.getElementById("topicMenu").innerHTML = data.title;
                    document.getElementById("topicMenu").href = `life-list.html?id=${topicId}`;
                });

                const q = query(collection(db, "death"), where("id", "==", id));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const contents = data.contents || [];

                    if (topicId != data.topic_id) {
                        contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                        return;
                    }

                    document.querySelectorAll(".page-title").forEach(el => el.textContent = data.title);
                    document.querySelector("#subtitle").innerHTML = data.desc;
                    docTitle += " - " + data.title;
                    document.title = docTitle;

                    contents.forEach(({ title, desc = "", list = [], unstyledList = [], orderdList = [], hadiths = [], quran = [] }) => {
                        let html = `<div class="mb-4"><h2>${title}</h2>`;

                        if (desc) html += `<p>${desc}</p>`;

                        if (list.length) {
                            html += `<ul>${list.map(item => `<li>${item}</li>`).join('')}</ul>`;
                        }

                        if (unstyledList.length) {
                            html += `<ul class="step-list list-unstyled px-4">${unstyledList.map(item => `<li>${item}</li>`).join('')}</ul>`;
                        }

                        if (orderdList.length) {
                            html += `<ol>${orderdList.map(item => `<li>${item}</li>`).join('')}</ol>`;
                        }

                        if (hadiths.length) {
                            hadiths.forEach(({ ar = "", text = "", reference = "" }) => {
                                html += `
                            <blockquote>
                                ${ar ? `<p dir="rtl" class="quran-text">${ar}</p>` : ""}
                                <p class="m-0">${text} ${reference ? `<br><span class="text-muted small fst-italic">- ${reference}</span>` : ""}</p>
                            </blockquote>`;
                            });
                        }

                        if (quran.length) {
                            quran.forEach(({ ar = "", text = "", reference = "" }) => {
                                html += `
                            <blockquote>
                                ${ar ? `<p dir="rtl" class="quran-text">${ar}</p>` : ""}
                                <p class="m-0">${text} ${reference ? `<br><span class="text-muted small fst-italic">- ${reference}</span>` : ""}</p>
                            </blockquote>`;
                            });
                        }

                        html += `</div>`;
                        contentContainer.insertAdjacentHTML("beforeend", html);
                        document.getElementById("shareBox").classList.remove("d-none");
                    });
                });

            } catch (error) {
                console.error("üî• Error loading data:", error);
                contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤.</div>`;
            } finally {
                if (loader) loader.style.display = "none";
            }
        });
    </script>
</body>

</html>