<!DOCTYPE html>
<html lang="ml">

<head>
    <span id="headContainer"></span>    
</head>

<body>
    <div class="loader" id="pageLoader">
        <div class="spinner"></div>
    </div>

    <span id="navbarContainer"></span>

    <header class="text-white text-center py-3 notranslate">
        <div class="container">
            <h1 class="page-title"></h1>
            <p id="subtitle"></p>
            <nav aria-label="breadcrumb" class="mt-2">
                <ol class="breadcrumb justify-content-center mb-0">
                    <li class="breadcrumb-item"><a href="index.html" class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item"><a href="life.html" class="text-decoration-none">Life of Muslim</a></li>
                    <li class="breadcrumb-item"><a href="#" class="text-decoration-none" id="topicMenu"></a></li>
                    <li class="breadcrumb-item active page-title" aria-current="page"></li>
                </ol>
            </nav>
        </div>
    </header>

    <main class="container my-3 notranslate">
        <span id="content"></span>

        <div class="text-center d-none" id="shareBox">
            <div class="p-4 rounded-4 shadow-sm share-box">
                <h4 class="fw-bold mb-3">üì§ ‡¥à ‡¥µ‡¥ø‡¥µ‡¥∞‡¥Ç ‡¥Æ‡¥±‡µç‡¥±‡µÅ‡¥≥‡µç‡¥≥‡¥µ‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥Ç ‡¥é‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÇ</h4>
                <p class="mb-4">
                    ‡¥¶‡µÅ‡¥Ü‡¥Ø‡µÅ‡¥Ç ‡¥ñ‡µà‡¥∞‡µÅ‡¥Ç ‡¥Æ‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡¥µ‡¥®‡µç‡¥±‡µÜ ‡¥™‡¥ø‡¥®‡µç‚Äç‡¥ï‡¥æ‡¥≤‡¥§‡µç‡¥§‡µç ‡¥§‡µÅ‡¥ü‡¥∞‡¥æ‡¥Ç. ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥í‡¥∞‡µÅ ‡¥™‡¥ô‡µç‡¥ï‡µÅ‡¥µ‡µÜ‡¥™‡µç‡¥™‡µç ‡¥Æ‡¥±‡µç‡¥±‡µä‡¥∞‡¥æ‡¥≥‡µÜ
                    ‡¥ì‡µº‡¥Æ‡µç‡¥Æ‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç.
                </p>
                <a href="javascript:void(0)" onclick="handleShare()" class="btn btn-primary rounded-pill px-4">üîó ‡¥∑‡µÜ‡¥Ø‡µº
                    ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÇ</a>
            </div>
        </div>
    </main>

    <!-- Hadith Modal -->
    <div class="modal fade" id="hadithModal" tabindex="-1" aria-labelledby="hadithModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title notranslate" id="hadithModalLabel">‡¥π‡¥¶‡µÄ‡¥∏‡µç ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div id="google_translate_element" class="mt-4 text-center"></div>

                <div class="modal-body" id="hadithModalBody">
                    <div class="text-center text-muted notranslate">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quran Modal -->
    <div class="modal fade notranslate" id="quranModal" tabindex="-1" aria-labelledby="quranModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title notranslate" id="quranModalLabel">‡¥ñ‡µÅ‡µº‡¥Ü‡µª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body" id="quranModalBody">
                    <div class="text-center text-muted notranslate">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube Modal -->
    <div class="modal fade notranslate" id="youtubeModal" tabindex="-1" aria-labelledby="youtubeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-black">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white" id="youtubeModalLabel">üé• Video Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="ratio ratio-16x9">
                        <iframe id="youtubeIframe" src="" title="YouTube video player" allowfullscreen
                            allow="autoplay"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <span id="footerContainer"></span>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/custom.js"></script>

    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'ml,en,hi,ar',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            },
                'google_translate_element'
            );
        }
    </script>
    <script type="text/javascript"
        src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script type="module">
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD9CrCyr09c27TBi-yViwyk0l8HN340IHQ",
            authDomain: "isp-db-2330.firebaseapp.com",
            projectId: "isp-db-2330",
            storageBucket: "isp-db-2330.firebasestorage.app",
            messagingSenderId: "466666491726",
            appId: "1:466666491726:web:c5e9649793d8352465581f",
            measurementId: "G-CMDJLRF946"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            query,
            where,
            doc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function saveData(fs_db, filePath) {
            const res = await fetch(filePath);
            const topics = await res.json();

            for (const topic of topics) {
                const ref = doc(db, fs_db, topic.id.toString());
                await setDoc(ref, topic);
                console.log("‚úÖ Uploaded:", topic.title);
            }
        }
        //saveData("death", "db/death.json");

        document.addEventListener("DOMContentLoaded", async () => {
            const idParam = new URLSearchParams(window.location.search).get("id");
            const id = parseInt(idParam);
            const topicIdParam = new URLSearchParams(window.location.search).get("topic");
            const topicId = parseInt(topicIdParam);
            const loader = document.getElementById("pageLoader");
            const contentContainer = document.querySelector("#content");
            let docTitle = "";
            const fs_db = {
                6: "death"
            };

            if (!id || isNaN(id) || !topicId || isNaN(topicId)) {
                contentContainer.innerHTML = `<div class="text-danger text-center">‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥Ø ID ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡µÅ.</div>`;
                if (loader) loader.style.display = "none";
                return;
            }

            try {
                const qry = query(collection(db, "life_of_muslim"), where("id", "==", topicId));
                const qrySnapshot = await getDocs(qry);

                if (qrySnapshot.empty) {
                    contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                    return;
                }

                qrySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();

                    docTitle = "‡¥Æ‡µÅ‡¥∏‡µç‡¥≤‡¥ø‡¥Æ‡¥ø‡µª‡µç‡¥±‡µÜ ‡¥ú‡µÄ‡¥µ‡¥ø‡¥§‡¥Ç | " + data.ml_title;
                    document.getElementById("topicMenu").innerHTML = data.ml_title;
                    document.getElementById("topicMenu").href = `life-list.html?id=${topicId}`;
                });

                const q = query(collection(db, fs_db[topicId]), where("id", "==", id));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const contents = data.contents || [];

                    if (topicId != data.topic_id) {
                        contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                        return;
                    }

                    document.querySelectorAll(".page-title").forEach(el => el.textContent = data.title);
                    document.querySelector("#subtitle").innerHTML = data.desc ?? "";
                    docTitle += " | " + data.title;
                    document.title = docTitle;

                    contents.forEach(({ title, desc = "", list = [], unstyledList = [], orderdList = [], hadiths = [], quran = [], youtube = "" }) => {
                        let html = `<div class="mb-2 section-card"><h2>${title}</h2>`;

                        if (desc) html += `<p class="mb-0">${desc}</p>`;

                        if (list.length) {
                            html += `<ul>${list.map(item => `<li>${item}</li>`).join('')}</ul>`;
                        }

                        if (unstyledList.length) {
                            html += `<ul class="step-list list-unstyled px-4">${unstyledList.map(item => `<li>${item}</li>`).join('')}</ul>`;
                        }

                        if (orderdList.length) {
                            html += `<ol>${orderdList.map(item => `<li>${item}</li>`).join('')}</ol>`;
                        }

                        if (hadiths.length) {
                            hadiths.forEach(({ ar = "", text = "", reference = "", book_slug = "", hadith_number = "" }) => {
                                html += `
                                    <blockquote class="mb-0 mt-1" onclick="viewHadith('${book_slug}', ${hadith_number})" style="cursor: pointer;">
                                        ${ar ? `<p dir="rtl" class="quran-text">${ar}</p>` : ""}
                                        ${text} 
                                        ${reference ? `<br><span class="text-muted small fst-italic"><i class="bi bi-file-text"></i> ${reference}</span>` : ""}
                                    </blockquote>`;
                            });
                        }

                        if (quran.length) {
                            quran.forEach(({ ar = "", text = "", reference = "", sura = "", ayah = "" }) => {
                                html += `
                                <blockquote class="m-0" onclick="viewQuran(${sura}, ${ayah})" style="cursor: pointer;">
                                    ${ar ? `<p dir="rtl" class="quran-text">${ar}</p>` : ""}
                                    ${text} 
                                    ${reference ? `<br><span class="text-muted small fst-italic"><i class="bi bi-file-text"></i> ${reference}</span>` : ""}
                                </blockquote>`;
                            });
                        }

                        if (youtube) {
                            html += `<button class="btn btn-primary ms-3" onclick="openYoutube('${youtube}')">üé• Video ‡¥ï‡¥æ‡¥£‡µÅ‡¥ï</button>`;
                        }

                        html += `</div>`;
                        contentContainer.insertAdjacentHTML("beforeend", html);
                        document.getElementById("shareBox").classList.remove("d-none");
                    });
                });

            } catch (error) {
                contentContainer.innerHTML = `<div class="text-danger text-center">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤.</div>`;
            } finally {
                if (loader) loader.style.display = "none";
            }
        });

        window.viewHadith = function (bookSlug, hadithNumber) {
            const modalElement = document.getElementById("hadithModal");
            const modalBody = document.getElementById("hadithModalBody");

            modalBody.innerHTML = `<div class="text-center text-muted py-3">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...</div>`;

            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.show();

            const API_KEY = "$2y$10$B8yax3MxHEcXfplBYp94edFIjUBgKs05qwd08hZESA9C9NHtAwP6";
            const url = `https://www.hadithapi.com/api/hadiths?apiKey=${API_KEY}&book=${bookSlug}&hadithNumber=${hadithNumber}`;

            fetch(url)
                .then(res => res.json())
                .then(response => {
                    const hadiths = response?.hadiths?.data;

                    if (response.status !== 200 || !hadiths || hadiths.length === 0) {
                        modalBody.innerHTML = `<div class="text-danger text-center py-3">‡¥π‡¥¶‡µÄ‡¥∏‡µç ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤. ‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥Æ‡¥±‡µç‡¥±‡µä‡¥®‡µç‡¥®‡µç ‡¥∂‡µç‡¥∞‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</div>`;
                        return;
                    }

                    modalBody.innerHTML = hadiths.map(hadith => `
                        <blockquote class="border-start ps-3 mb-3">
                            ${hadith.headingArabic ? `
                                <p class="quran-text notranslate fw-bold fs-5 m-0" dir="rtl">${hadith.headingArabic}</p>
                                <p class="fw-bold mt-1">${hadith.headingEnglish || ""}</p>` : ""
                        }

                            ${hadith.hadithArabic ? `<p dir="rtl" class="fs-5 mt-3 notranslate">${hadith.hadithArabic}</p>` : ""}
                            <p class="mt-2">${hadith.hadithEnglish || "<em>No translation available</em>"}</p>
                            <p class="text-muted small notranslate mt-2 fst-italic">
                                ${hadith.book.bookName},
                                Volume: ${hadith.volume},
                                Chapter: #${hadith.chapter.chapterNumber} - ${hadith.chapter.chapterEnglish},
                                Hadith: #${hadith.hadithNumber},
                                Status: ${hadith.status || "Unknown"}
                            </p>
                        </blockquote>
                    `).join("");
                })
                .catch(err => {
                    modalBody.innerHTML = `<div class="text-danger text-center py-3">‡¥π‡¥¶‡µÄ‡¥∏‡µç ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                });
        };

        window.viewQuran = function (sura, ayah) {
            const modalElement = document.getElementById("quranModal");
            const modalBody = document.getElementById("quranModalBody");

            modalBody.innerHTML = `<div class="text-center text-muted py-3">‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...</div>`;

            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.show();

            const url = `https://api.alquran.cloud/v1/ayah/${sura}:${ayah}/editions/quran-uthman,ml.abdulhameed`;

            fetch(url)
                .then(res => res.json())
                .then(response => {
                    const quran = response.data;
                    if (response.code !== 200 || !quran || quran.length === 0) {
                        modalBody.innerHTML = `<div class="text-danger text-center py-3">‡¥ñ‡µÅ‡µº‡¥Ü‡µª ‡¥≤‡¥≠‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µç‡¥≤. ‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥Æ‡¥±‡µç‡¥±‡µä‡¥®‡µç‡¥®‡µç ‡¥∂‡µç‡¥∞‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.</div>`;
                        return;
                    }

                    const arabic = quran.filter(verse => verse.edition.language === "ar")[0];
                    const malayalam = quran.filter(verse => verse.edition.language === "ml")[0];

                    modalBody.innerHTML = `
                        <blockquote class="border-start ps-3 mb-3 notranslate">
                            <p dir="rtl" class="fs-5 mt-3 quran-text" style="line-height: 2.2;">${arabic.text}</p>
                            <p class="mt-2">${malayalam.text || "<em>No translation available</em>"}</p>
                            <p class="text-muted small fst-italic mt-2">${arabic.surah.number}. ${arabic.surah.englishName}: ${arabic.numberInSurah}</p>
                        </blockquote>
                    `;
                })
                .catch(err => {
                    modalBody.innerHTML = `<div class="text-danger text-center py-3">‡¥ñ‡µÅ‡µº‡¥Ü‡µª ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤.</div>`;
                });
        };

        window.openYoutube = function (videoId) {
            const iframe = document.getElementById("youtubeIframe");
            const modal = new bootstrap.Modal(document.getElementById("youtubeModal"));

            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&&modestbranding=1&rel=0`;
            modal.show();

            document.getElementById("youtubeModal").addEventListener("hidden.bs.modal", () => { iframe.src = ""; }, { once: true });
        };
    </script>
</body>

</html>